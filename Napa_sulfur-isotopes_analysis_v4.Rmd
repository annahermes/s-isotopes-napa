---
title: "Napa-sulfur-isotopes-analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

Code for analyzing sulfur isotope data comparing vineyard agriculture and non-agricultural areas of the Napa River Watershed, CA, USA.

## Description
This repository includes data visualization and analysis code used for the manuscript:
Hermes, A.L., Dawson, T.E., and Hinckley, E.-L.S. (2022) Sulfur isotopes reveal agricultural changes to the modern sulfur cycle. Environmental Research Letters, 17: 054032. https://doi.org/10.1088/1748-9326/ac6683

_v4 is code for the final published article but scrubbed with directory links.
_v3 is code for the final published article.
_v2 was code for the initial article submission.

## Setup
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(readxl)
library(reshape)
library(ggrepel)
library(data.table)
library(FSA)
library(siar)
library(MixSIAR)
library(MASS)
library(scales)
library(gridExtra)

require("knitr")

# Set working drive:
setwd()

```

## Import and clean data
A number of input datasets are required that are either provided in this repository or can be downloaded from public domain sources.

### watershed-wide sulfur isotopes (this study)
These data were generated for this manuscript.

Download "NapaSulfurIsotopes_v1.csv" from:
https://doi.org/10.6073/pasta/8b81b39d87d5f70325420294ffc83ddf

```{r import-watershed-S-isotopes}

# import data table
all <- read.csv("NapaSulfurIsotopes_v1.csv")

# check it out!
summary(all)

# update class types
all$site_name <- as.factor(all$site_name)
all$sample_type <- as.factor(all$sample_type)
all$prcnt_vineyard <- as.numeric(all$prcnt_vineyard)
all$prcnt_nonag <- as.numeric(all$prcnt_nonag)
all$prcnt_other <- as.numeric(all$prcnt_other)
all$sulfate_mgSperL <- as.numeric(all$sulfate_mgSperL)
all$d34S <- as.numeric(all$d34S) 
all$WY <- as.factor(all$WY)
all$sample_collection_date <- as.Date(all$sample_collection_date)
all$gypsum <- as.factor(all$gypsum)


summary(all)

```

Remove outlier
```{r minus-outlier}
# one irrigation water sample was collected during a spurious irrigation event. removed from analysis.
allno <- filter(all, d34S < 22)

```

Make a data table without the S-fungicide data & irrigation water
```{r remove-S-fungicide}
# S fungicide numbers will plot separately - remove for sulfate-d34s map figures
allnoF <- filter(allno, sample_type != "sulfur fungicide")
allnoF <- filter(allnoF, sample_type != "irrigation water")

```


### lab soil leachate sulfur isotopes (prior study)
These data are from the following citation:
Hermes, A.L., Ebel, B.A., Murphy, S.F., and E.-L.S. Hinckley (2021). Fates and fingerprints of sulfur and carbon following wildfire in economically important croplands of California, U.S. Science of the Total Environment, 750(1): 142179.
https://doi.org/10.1016/j.scitotenv.2020.142179

Data are available through the Environmental Data Initiative.
Download the "napa_fire_leachingexpisotopes.csv" table from:
https://doi.org/10.6073/pasta/4473046a81e564b5bc0ccedcc2def131

```{r import-lab-soil-leachate-S-isotopes}

# import data table
leach <- read.csv("napa_fire_leachingexpisotopes.csv")

# check it out!
summary(leach)

# rename columns
colnames(leach)[6] <- "d34S"
colnames(leach)[7] <- "sulfate_mgSperL"

# only keep grassland and vineyard (not the burned samples)
leachfilt <- filter(leach, burn_unburn == "unburned")

# rename "grassland" to "native"
leachfilt$site_type[leachfilt$site_type == "grassland"] <- "forest/shrubland/grassland"

# create a % vineyard column
leachfilt$prcnt_vineyard <- as.numeric(as.factor(leachfilt$site_type))
leachfilt$prcnt_vineyard[leachfilt$prcnt_vineyard == 1] <- 0
leachfilt$prcnt_vineyard[leachfilt$prcnt_vineyard == 2] <- 100

```

### field-scale d34S vineyard data (prior study)
These data are from the following citation:
Hinckley, E.-L.S., Kendall, C., and Loague, K. (2008) Not all water becomes wine: Sulfur inputs as an opportune tracer of hydrochemcial losses from vineyards. Water Resources Research, 44(7): W00401.
https://doi.org/10.1029/2007WR006672

Download the "hinckley-etal-2008-WRR.csv" table from this Github repository.

```{r import-Hinckley-data}

# import data table
hinckley <- read.csv("hinckley-etal-2008-WRR.csv")

# check it out!
summary(hinckley)


# convert sample_type to a factor
hinckley$sample_type <- as.factor(hinckley$sample_type)

# convert sulfate as sulfate to sulfate as sulfur
hinckley$sulfate_mgSperL <- hinckley$sulfate_ppm * 32.065/96.06

```

### Burke et al. (2018) global rivers data (prior study)
These data are from the following citation:
Burke, A. et al. (2018) Sulfur isotopes in rivers: Insights into global weathering budgets, pyrite oxidation, and the modern sulfur cycle. Earth and Planetary Science Letters, 496: 168-177. https://doi.org/10.1016/j.epsl.2018.05.022

Download MMC 2. Supplementary data Table 1.
```{r import-Burke-etal}

# import data table
burke <- read_excel("1-s2.0-S0012821X18302991-mmc2.xlsx",
                    sheet = "Table 1")

summary(burke)

# change column headers
names(burke)[7] <- "d34S"
summary(burke)
names(burke)[9] <- "so4_uM"
summary(burke)

# calculate sulfate in mg/L
burke$sulfate_mgSPerL <- burke$so4_uM*32.065/1000


```


## Plot data

### Main manuscript

#### Manuscript Figure 2
This figure plots sulfate concentration vs. sulfur isotope values.
Sample type is designated by point shape.
Land use/land cover category is designated by color.

```{r plot-Fig2}

# First determine x and y ranges for precipitation and irrigation water

# From Hinckley et al. (2008)
hinckley %>% group_by(sample_type) %>% summarise(minSO4 = min(sulfate_mgSperL, na.rm = TRUE),
                                                 maxSO4 = max(sulfate_mgSperL, na.rm = TRUE),
                                                 mind34S = min(d34S, na.rm = TRUE),
                                                 maxd34S = max(d34S, na.rm = TRUE))

# From this study
allno %>% group_by(sample_type) %>% summarise(minSO4 = min(sulfate_mgSperL, na.rm = TRUE),
                                                 maxSO4 = max(sulfate_mgSperL, na.rm = TRUE),
                                                 mind34S = min(d34S, na.rm = TRUE),
                                                 maxd34S = max(d34S, na.rm = TRUE))

# And the median and range of S fungicide values
all %>% group_by(sample_type) %>% summarise(mind34S = min(d34S, na.rm = TRUE),
                                            maxd34S = max(d34S, na.rm = TRUE),
                                            meand34S = mean(d34S, na.rm = TRUE),
                                            mediand34S = median(d34S, na.rm = TRUE))

# Make the plot
colorLULC_discrete <- ggplot() +
  # First plot a shaded box that encompasses all precip/irrigation sulfur "source" values
  annotate("rect",
           xmin = 0.16,
           xmax = 3.24,
           ymin = 2.44,
           ymax = 7.47,
           fill = "gray") +
  # Then plot the S fungicide values
  # median = 3.09, min = 0.95, max = 4.97
  annotate("pointrange",
           x = 0,
           y = 3.09,
           ymin = 0.95,
           ymax = 4.97,
           color = "saddlebrown",
           size = 1) +
  # Then add laboratory soil leachate as a laboratory-based "endmember"
  geom_point(data = leachfilt,
             aes(sulfate_mgSperL,
                 d34S,
                 color = site_type),
             shape = 3,
             size = 5) +
  # layer in all samples except the Napa River
  geom_point(data = filter(allnoF, lulc_abbrev != "napa river"),
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1, size = 5) +
  # then add in Napa River points so that they show up over the rest
  geom_point(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(sulfate_mgSperL,
                 d34S,
                 shape = sample_type,
                 color = lulc_abbrev),
             stroke = 1.1,
             size = 5,
             shape = 17) +
  geom_text_repel(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(sulfate_mgSperL,
                 d34S,
                 label = site_no),
             size = 6,
             box.padding = 0.5) +
  # finally, format everything
  scale_shape_manual(limits = factor(c("soil leachate", "soil water", "spring water", "culvert outflow","stream water")),
                     values = c(3, 4, 1, 5, 17),
                     labels = c("soil leachate", "soil water", "spring water", "culvert outflow","stream water")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed","napa river")),
                     values = c("springgreen4", "violetred", "darkorange1","black"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed","Napa River")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample type:",
       color = "Land use/land cover:") +
  scale_x_continuous(limits = c(0, 80), breaks = seq(0, 80, 10), expand = expansion(mult = c(0.02,0))) + 
  scale_y_continuous(limits = c(-10, 21), breaks = seq(-10, 21, 5), expand = expansion(mult = c(0.02,0.02))) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 16),
        axis.text.x  = element_text(size = 16,
                                    color = "black"),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16,
                                   color = "black"),
        plot.title = element_text(size = 16),
        legend.title = element_text(size = 16),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 14)) +
  theme(legend.text.align = 0)

# take a look!
colorLULC_discrete

```

```{r save-Fig2}
# generic
ggsave(colorLULC_discrete, filename = "Fig2a.png",
       width = 10,
       height = 4,
       bg = "transparent")


# PDF
pdf(file = "Fig2a.pdf",
    width = 10,
    height = 5)
colorLULC_discrete
dev.off()
```

#### Manuscript Figure 4
This plot compares our measurements to those compiled by Burke et al. (2018) EPSL from rivers around the globe. There are 4 versions of the plot, the most clear was selected for publication.


```{r Burke_plot_raw}

Burkecompare <- ggplot() +
  # Plot Burke data
  geom_point(data = burke,
             aes(sulfate_mgSPerL,
                 d34S),
             shape = 16,
             size = 2,
             color = "black") +
  # layer in all samples except the Napa River
  geom_point(data = filter(allnoF, lulc_abbrev != "napa river"),
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1, size = 3) +
  # then add in Napa River points so that they show up over the rest
  geom_point(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(sulfate_mgSperL,
                 d34S,
                 shape = sample_type,
                 color = lulc_abbrev),
             stroke = 1.1,
             size = 3,
             shape = 17) +
  # finally, format everything
    scale_y_continuous(limits = c(-15, 25), breaks = seq(-15, 25, 5), expand = expansion(mult = c(0.02,0.02))) +
  scale_shape_manual(limits = factor(c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")),
                     values = c(4, 1, 5, 17, 20),
                     labels = c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed","napa river")),
                     values = c("springgreen4", "violetred", "darkorange1","black"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed","River")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample type:",
       color = "Land use/land cover:") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)


Burkecompare
```

```{r Burke_plot_log}

Burkelogx <- ggplot() +
  # plot Burke average/range
  geom_hline(yintercept = 4.4,
             linetype = "dashed",
             color = "darkgrey") +
  # Plot Burke data
  geom_point(data = burke,
             aes(sulfate_mgSPerL,
                 d34S),
             shape = 16,
             size = 2,
             color = "black") +
  # layer in all samples except the Napa River
  geom_point(data = filter(allnoF, lulc_abbrev != "napa river"),
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1, size = 5) +
  # then add in Napa River points so that they show up over the rest
  geom_point(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(sulfate_mgSperL,
                 d34S,
                 shape = sample_type,
                 color = lulc_abbrev),
             stroke = 1.1,
             size = 5,
             shape = 17) +
  # finally, format everything
  scale_shape_manual(limits = factor(c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")),
                     values = c(4, 1, 5, 17, 20),
                     labels = c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed","napa river")),
                     values = c("springgreen4", "violetred", "darkorange1","black"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed","River")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample type:",
       color = "Land use/land cover:") +
  
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = label_comma(drop0trailing = TRUE)) + 
  scale_y_continuous(limits = c(-15, 25), breaks = seq(-15, 25, 5), expand = expansion(mult = c(0.02,0.02))) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 16),
        axis.text.x  = element_text(size = 16,
                                    color = "black"),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16,
                                   color = "black"),
        plot.title = element_text(size = 16),
        legend.title = element_text(size = 16),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 14)) +
  theme(legend.text.align = 0)


Burkelogx

```

```{r save-Burke-logx}
pdf(file = "Fig4.pdf",
    width = 10,
    height = 5)
Burkelogx
dev.off()

```

```{r Burke-plot-inverse}

Burkeinverse <- ggplot() +
  # Plot Burke data
  geom_point(data = burke,
             aes(1/sulfate_mgSPerL,
                 d34S),
             shape = 16,
             size = 2,
             color = "black") +
  # layer in all samples except the Napa River
  geom_point(data = filter(allnoF, lulc_abbrev != "napa river"),
                     aes(1/sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1, size = 3) +
  # then add in Napa River points so that they show up over the rest
  geom_point(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(1/sulfate_mgSperL,
                 d34S,
                 shape = sample_type,
                 color = lulc_abbrev),
             stroke = 1.1,
             size = 3,
             shape = 17) +
  # finally, format everything
    scale_y_continuous(limits = c(-15, 25), breaks = seq(-15, 25, 5), expand = expansion(mult = c(0.02,0.02))) +
  scale_shape_manual(limits = factor(c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")),
                     values = c(4, 1, 5, 17, 20),
                     labels = c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed","napa river")),
                     values = c("springgreen4", "violetred", "darkorange1","black"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed","River")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("1/SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample type:",
       color = "Land use/land cover:") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)


Burkeinverse

```

```{r Burke-plot-inverselog}

Burkeinverselog <- ggplot() +
  # Plot Burke data
  geom_point(data = burke,
             aes(1/sulfate_mgSPerL,
                 d34S),
             shape = 16,
             size = 2,
             color = "black") +
  # layer in all samples except the Napa River
  geom_point(data = filter(allnoF, lulc_abbrev != "napa river"),
                     aes(1/sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1, size = 3) +
  # then add in Napa River points so that they show up over the rest
  geom_point(data = filter(allnoF, lulc_abbrev == "napa river"),
             aes(1/sulfate_mgSperL,
                 d34S,
                 shape = sample_type,
                 color = lulc_abbrev),
             stroke = 1.1,
             size = 3,
             shape = 17) +
  # finally, format everything
    scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = label_comma(drop0trailing = TRUE)) + 
    scale_y_continuous(limits = c(-15, 25), breaks = seq(-15, 25, 5), expand = expansion(mult = c(0.02,0.02))) +
  scale_shape_manual(limits = factor(c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")),
                     values = c(4, 1, 5, 17, 20),
                     labels = c("soil water", "spring water", "culvert outflow","stream water", "Burke et al. (2018)")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed","napa river")),
                     values = c("springgreen4", "violetred", "darkorange1","black"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed","River")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("1/SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample type:",
       color = "Land use/land cover:") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)


Burkeinverselog

```

### Supplementary Materials 

#### Supplementary figure 2: compare soil porewater sampling methods
This figure depicts two points:
1) that sulfur isotopes do not appear to be an artifact of soil lysimeter sampling methods, and
2) that the pattern of sulfur isotope/concentration values is robust across vineyards and over time.

It combines new data from this study with data from Hinckley et al. (2008).

```{r plot-FigS2}

#### Merge datasets ####

# Subset data from this study
newsoilwater <- filter(allnoF, sample_type == "soil water")
newsoilwater <- newsoilwater[,c(10,17,18)]
# names(newsoilwater)[2] <- "sulfate_asS_mgL"

# Subset data from Hinckley et al. (2008)
oldsoilwater <- hinckley[,c(4,6,7)]
oldsoilwater <- filter(oldsoilwater, sample_type %in% c("matrix flow","preferential flow"))

# Combine
allsoilwater <- full_join(newsoilwater,oldsoilwater)

allsoilwater$study <- "Hinckley"
allsoilwater$study[allsoilwater$sample_type == "soil water"] <- "Hermes"
allsoilwater$study <- as.factor(allsoilwater$study)

#### Plot ####

allsoilwaterplot <- ggplot() +
  # plot a logarithmic curve
  stat_smooth(data = allsoilwater,
                     aes(sulfate_mgSperL,
                         d34S),
              method = "lm",
              formula = y ~ log(x),
              # se = FALSE,
              color = "black",
              linetype = "dashed") +
  # plot soil points
  geom_point(data = allsoilwater,
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = sample_type),
             stroke = 1.1, size = 4) +
  scale_shape_manual(name = "Sample type:",
                     values = c(4, 20, 21),
                     labels = c("Soil water (this study)",
                                "Matrix flow (Hinckley et al., 2008)",
                                "Preferential flow (Hinckley et al., 2008)")) +
  scale_color_manual(name = "Sample type:",
                     values = c("violetred","slateblue4","goldenrod"),
                     labels = c("Soil water (this study)",
                                "Matrix flow (Hinckley et al., 2008)",
                                "Preferential flow (Hinckley et al., 2008)")) +
  labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)"))) +
  scale_x_continuous(limits = c(0, 85), breaks = seq(0, 85, 10)) + 
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 16),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text.align = 0)


# take a look!
allsoilwaterplot

```

```{r save-FigS2}

ggsave(allsoilwaterplot, filename = "FigS2.png",
       width = 12,
       height = 6,
       bg = "transparent")


pdf(file = "FigS2.pdf",
    width = 12,
    height = 5)
allsoilwaterplot
dev.off()
```

#### Supplementary figure 3: sub-catchment plot
This figure plots Napa Watershed catchments with mixed land use/land cover.

As in Fig 2, sample type is designated by point shape.
Land use/land cover category is designated by color.

NOTE: This figure was annotated in the printed manuscript.

```{r plot-save-FigS3}

# First determine x and y ranges for precipitation and irrigation water

# From Hinckley et al. (2008)
hinckley %>% group_by(sample_type) %>% summarise(minSO4 = min(sulfate_mgSperL, na.rm = TRUE),
                                                 maxSO4 = max(sulfate_mgSperL, na.rm = TRUE),
                                                 mind34S = min(d34S, na.rm = TRUE),
                                                 maxd34S = max(d34S, na.rm = TRUE))

# From this study
allno %>% group_by(sample_type) %>% summarise(minSO4 = min(sulfate_mgSperL, na.rm = TRUE),
                                                 maxSO4 = max(sulfate_mgSperL, na.rm = TRUE),
                                                 mind34S = min(d34S, na.rm = TRUE),
                                                 maxd34S = max(d34S, na.rm = TRUE))

# And the median and range of S fungicide values
all %>% group_by(sample_type) %>% summarise(mind34S = min(d34S, na.rm = TRUE),
                                            maxd34S = max(d34S, na.rm = TRUE),
                                            meand34S = mean(d34S, na.rm = TRUE),
                                            mediand34S = median(d34S, na.rm = TRUE))

# Then make the plot - first of Northern catchment system
subcatchN <- ggplot() +
  # First plot a shaded box that encompasses all precip/irrigation sulfur "source" values
  annotate("rect",
           xmin = 0.16,
           xmax = 3.24,
           ymin = 2.44,
           ymax = 7.47,
           alpha = 0.5,
           fill = "gray") +
  # Then plot the S fungicide values
  # median = 3.09, min = 0.95, max = 4.97
  annotate("pointrange",
           x = 0,
           y = 3.09,
           ymin = 0.95,
           ymax = 4.97,
           color = "saddlebrown",
           size = 1) +
  # select sites in Northern catchment
  geom_point(data = filter(allnoF,site_name %in% c("grassland",
                                                   "Terraced vineyard 1",
                                                   "Sulphur Creek")),
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1,
             size = 4) + 
  scale_shape_manual(values = c(5, 4, 1, 17)) +
  scale_color_manual(values = c("springgreen4","violetred")) +
    labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample Type:",
       color = "LULC:") +
  #scale_x_continuous(limits = c(0, 80), breaks = seq(0, 80, 10), expand = expansion(mult = c(0.02,0))) + 
  scale_y_continuous(limits = c(-10, 15), breaks = seq(-10, 15, 5), expand = expansion(mult = c(0.02,0.02))) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        #legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)

# take a look!
subcatchN

# and save
ggsave(subcatchN, filename = "D:/Google Drive/Research/HermesA_Research/Figures/s-isotope-map/Subcatch1.png",
       width = 8,
       height = 4,
       bg = "transparent")

# Then make the plot for mid-watershed catchment
subcatchV <- ggplot() +
  # First plot a shaded box that encompasses all precip/irrigation sulfur "source" values
  annotate("rect",
           xmin = 0.16,
           xmax = 3.24,
           ymin = 2.44,
           ymax = 7.47,
           alpha = 0.5,
           fill = "gray") +
  # Then plot the S fungicide values
  # median = 3.09, min = 0.95, max = 4.97
  annotate("pointrange",
           x = 0,
           y = 3.09,
           ymin = 0.95,
           ymax = 4.97,
           color = "saddlebrown",
           size = 1) +
  # select the mid-valley sites
  geom_point(data = filter(allnoF,site_name %in% c("Valley vineyard 1",
                                                        "Valley vineyard 2",
                                                        "To Kalon Creek")),
                     aes(sulfate_mgSperL,
                         d34S,
                         shape = sample_type,
                         color = lulc_abbrev),
             stroke = 1.1,
             size = 4) + 
  # scale_shape_manual(values = c(5, 4, 17)) +
  # scale_color_manual(values = c("springgreen4", "darkorange1","violetred")) +
  # finally, format everything
  scale_shape_manual(limits = factor(c("soil water", "spring water", "culvert outflow","stream water")),
                     values = c(4, 1, 5, 17),
                     labels = c("soil water", "spring water", "culvert outflow","stream water")) +
  scale_color_manual(limits = factor(c("forest/shrubland/grassland","vineyard","mixed")),
                     values = c("springgreen4", "violetred", "darkorange1"),
                     labels = c("forest/shrubland/grassland","vineyard","mixed")) +
  guides(color = guide_legend(override.aes = list(shape = 15, size = 5))) +
  labs(x = expression(paste("SO"[4]^2^-{},"(mg S L"^-1,")")),
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample Type:",
       color = "LULC:") +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 10), expand = expansion(mult = c(0.02,0))) + 
  scale_y_continuous(limits = c(-5, 20), breaks = seq(-5, 20, 5), expand = expansion(mult = c(0.02,0.02))) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        #legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)

# take a look!
subcatchV

ggsave(subcatchV, filename = "Subcatch2.png",
       width = 8,
       height = 4,
       bg = "transparent")

```

#### Supplementary figure 4: plus-minus gypsum
This plot compares d34S values between vineyards that do and do not receive gypsum additions.

```{r plot_FigS4}
gypsumplot <- allnoF %>% 
  filter(lulc_abbrev == "vineyard" & sample_type == "soil water") %>% 
  ggplot(aes(gypsum, d34S)) + 
  geom_boxplot() + 
  geom_point() +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) + 
  theme_bw() +
  labs(x = "Gypsum Addition",
       y = expression(paste(delta^{34}, "S-SO"[4]^2^-{}, "(\u2030)")),
       shape = "Sample Type:") +
    theme(axis.title.x = element_text(size = 20),
        axis.text.x  = element_text(size = 20,
                                    color = "black"),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 20,
                                   color = "black"),
        plot.title = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        rect = element_rect(fill = "transparent"),
        panel.background = element_rect(fill = "transparent", color = NA),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(legend.text = element_text(size = 16)) +
  theme(legend.text.align = 0)
gypsumplot
```

```{r save-FigS4}

ggsave(gypsumplot, filename = "plus-minus-gypsum.png",
       width = 12,
       height = 6,
       bg = "transparent")

```


# Analyze data

### Calculate summary statistics

```{r summary-stats}

# Calculate d34S and sulfate concentration summary statistics by LULC type
summarystats <- allnoF %>% group_by(lulc_abbrev) %>% summarise(meanSO4 = mean(sulfate_mgSperL),
                                                               stdSO4 = sd(sulfate_mgSperL),
                                                               medianSO4 = median(sulfate_mgSperL),
                                                               iqrSO4 = IQR(sulfate_mgSperL),
                                                               minSO4 = min(sulfate_mgSperL),
                                                               maxSO4 = max(sulfate_mgSperL),
                                                               meand34S = mean(d34S),
                                                               stdd34S = sd(d34S),
                                                               mediand34S = median(d34S),
                                                               iqrd34S = IQR(d34S),
                                                               mind34S = min(d34S),
                                                               maxd34S = max(d34S),
                                                               N = n())

summarystats$rangeSO4 <- summarystats$maxSO4 - summarystats$minSO4
summarystats$ranged34S <- abs(summarystats$maxd34S - summarystats$mind34S)

summarystats

# Calculate ranges for all samples for comparison with Burke et al.

riverd34S <- allnoF %>% filter(sample_type == c("stream water", "napa river")) %>% summarise(mind34S = min(d34S, na.rm = TRUE),
                                                                                             maxd34S = max(d34S, na.rm = TRUE))
riverd34S$range <- riverd34S$maxd34S - riverd34S$mind34S

# Calculate summary stats for Hinckley et al. (2008) data
hinckley %>% group_by(sample_type) %>% summarise(meanSO4 = mean(sulfate_mgSperL),
                                                 sdSO4 = sd(sulfate_mgSperL),
                                                 medianSO4 = median(sulfate_mgSperL),
                                                 iqrSO4 = IQR(sulfate_mgSperL),
                                                 meand34S = mean(d34S),
                                                 sdd34S = sd(d34S),
                                                 mediand34S = median(d34S),
                                                 iqrd34S = IQR(d34S),
                                                 min34S = min(d34S),
                                                 max34S = max(d34S),
                                                 N = n())

# Calculate summary stats for S fungicide samples
allno %>% filter(sample_type == "sulfur fungicide") %>% summarise(mean = mean(d34S),
                                                             median = median(d34S),
                                                             iqr = IQR(d34S),
                                                             min = min(d34S),
                                                             max = max(d34S),
                                                             N = n())

# Calculate summary stats for Hermes et al. (2021) soil leachate
leachfilt %>% group_by(site_type) %>% summarise(median = median(d34S, na.rm = TRUE),
                                           iqr = IQR(d34S, na.rm = TRUE),
                                           N = n())

# Calculate summary stats for stream S flux
flux %>% group_by(lulc_abbrev) %>% summarise(median = median(flux_kgSperhaperyr, na.rm = TRUE),
                                             mean = mean(flux_kgSperhaperyr, na.rm = TRUE),
                                             sd = sd(flux_kgSperhaperyr, na.rm = TRUE))


# Calculate overall isotope mean and sd to compare with Burke et al. 2018
# without soil water
allnoF %>% filter(sample_type != c("irrigation water", "soil water")) %>% summarise(mean = mean(d34S, na.rm = TRUE),
                                                                                    sd = sd(d34S, na.rm = TRUE),
                                                                                    N = n())
# 5.61 +/- 6.45, n = 98

# split vineyards into low and high S concentrations
allnoF %>% group_by(lulc_abbrev) %>% filter(sulfate_mgSperL > 22) %>% summarise(median = median(d34S, na.rm = TRUE), iqr = IQR(d34S, na.rm = TRUE), range = max(d34S, na.rm = TRUE) - min(d34S, na.rm = TRUE), N = n())
```

### Statistical tests
The ideal test for this dataset is a manova, which would test for differences in the multivariate d34S and sulfate concentrations across LULC groups. 

However, the data violate manova assumptions. First, a number of data points come from the same location at multiple points in time (non-independent), and second, the data are not normally distributed. 

Thus, we use non-parametric statistical analyses. We first use a Kruskal Wallis rank sum test with adjusted p-values followed by Dunn's tests to determine differences across groups.

For all statistical tests, we considered a p-value of < 0.05 significant.

```{r non-parametric-tests}

# First make lulc factor
allnoF$lulc_abbrev <- as.factor(allnoF$lulc_abbrev)

levels(allnoF$lulc_abbrev)
# levels are "mixed", "napa river", "forest/shrubland/grassland", and "vineyard"


#### Are differences in d34S across groups? ####
kruskal.test(d34S ~ lulc_abbrev,
             data = allnoF)

# Kruskal-Wallis rank sum test
# 
# data:  d34S by lulc_abbrev
# Kruskal-Wallis chi-squared = 55.768, df = 3, p-value = 4.708e-12

# YES, there are differences across groups since the p-value is << 0.05

# Follow with a post-hoc test with adjusted p-value to find what the differences are

# The Dunn test
dunnTest(d34S ~ lulc_abbrev,
         data = allnoF,
         method = "holm")
#                                Comparison          Z      P.unadj        P.adj
# 1      forest/shrubland/grassland - mixed -1.0262457 3.047758e-01 6.095515e-01 NO DIFF
# 2 forest/shrubland/grassland - napa river -4.4809773 7.430201e-06 3.715100e-05 DIFF
# 3                      mixed - napa river -3.1928356 1.408831e-03 4.226494e-03 DIFF
# 4   forest/shrubland/grassland - vineyard -6.7067004 1.990743e-11 1.194446e-10 DIFF
# 5                        mixed - vineyard -4.3628198 1.283967e-05 5.135867e-05 DIFF
# 6                   napa river - vineyard -0.1112654 9.114059e-01 9.114059e-01 NO DIFF


#### Are differences in [SO4] across groups? ####
kruskal.test(sulfate_mgSperL ~ lulc_abbrev,
             data = allnoF)

# Kruskal-Wallis rank sum test
# 
# data:  final_sulfate_mgSperL by lulc_abbrev
# Kruskal-Wallis chi-squared = 21.226, df = 3, p-value = 9.448e-05

# YES, there are differences across groups since the p-value is << 0.05

# Follow with a post-hoc test with adjusted p-value to find what the differences are

# The Dunn test
dunnTest(sulfate_mgSperL ~ lulc_abbrev,
         data = allnoF,
         method = "holm")
#             Comparison          Z      P.unadj        P.adj
# 1    mixed - napa river  0.8659865 3.864975e-01 1.0000000000  Not Diff
# 2        mixed - native  3.5412571 3.982254e-04 0.0019911270  Diff
# 3   napa river - native  2.2766814 2.280526e-02 0.0912210252  Not Diff
# 4      mixed - vineyard  0.3669021 7.136921e-01 0.7136920766  Not Diff
# 5 napa river - vineyard -0.7044557 4.811490e-01 0.9622980079  Not Diff
# 6     native - vineyard -4.2878759 1.803898e-05 0.0001082339  Diff



```

```{r gypsum}

# pull out data with gypsum designation only
gyptest <- 
  allnoF %>% filter(lulc_abbrev == "vineyard" & sample_type == "soil water")

t.test(d34S ~ gypsum,
       data = gyptest)
# p = 6.054e-06 reject null hypothesis that diff in means is equal to zero (true diff in means is not equal to 0)
# means: no - 7.28 permil, yes - 12.44 permil

gyptest %>% group_by(gypsum) %>% summarise(med = median(d34S),
                                           count = n())
```